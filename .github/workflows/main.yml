name: Build and Push Monorepo

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repo
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-west-3
          role-session-name: GitHubActionsSession

      # Step 3: Login to ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Step 4: Determine changed folders (FIXED for first commit)
      - name: Set changed folders
        id: changes
        run: |
          echo "CHANGED_BACKEND=false" >> $GITHUB_ENV
          echo "CHANGED_FRONTEND=false" >> $GITHUB_ENV
          
          # Get changed files - handles first commit edge case
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || git ls-tree -r HEAD --name-only)
          echo "Changed files: $CHANGED_FILES"
          
          if echo "$CHANGED_FILES" | grep -q "^backend/"; then
            echo "CHANGED_BACKEND=true" >> $GITHUB_ENV
          fi
          if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
            echo "CHANGED_FRONTEND=true" >> $GITHUB_ENV
          fi

      # Step 5: Build & push backend (only if backend changed)
      - name: Build and Push Backend
        if: env.CHANGED_BACKEND == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          BACKEND_REPO: my-company/backend
        run: |
          docker build -t $ECR_REGISTRY/$BACKEND_REPO:latest -t $ECR_REGISTRY/$BACKEND_REPO:${GITHUB_SHA} ./backend
          docker push $ECR_REGISTRY/$BACKEND_REPO:latest
          docker push $ECR_REGISTRY/$BACKEND_REPO:${GITHUB_SHA}

      # Step 6: Build & push frontend (only if frontend changed)
      - name: Build and Push Frontend
        if: env.CHANGED_FRONTEND == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          FRONTEND_REPO: my-company/frontend
        run: |
          docker build -t $ECR_REGISTRY/$FRONTEND_REPO:latest -t $ECR_REGISTRY/$FRONTEND_REPO:${GITHUB_SHA} ./frontend
          docker push $ECR_REGISTRY/$FRONTEND_REPO:latest
          docker push $ECR_REGISTRY/$FRONTEND_REPO:${GITHUB_SHA}